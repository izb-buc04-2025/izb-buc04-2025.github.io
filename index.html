<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Upload to Firebase</title>

    <!-- Firebase SDK for ES Modules -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-storage.js";
        import { getFirestore, collection, addDoc, getDocs, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // Firebase Configuration (replace with your Firebase details)
        const firebaseConfig = {
            apiKey: "AIzaSyADzvt0GHQn2PhdRVGGgDdOLb_f9AzDQJw",
            authDomain: "izb-buc04-2025-22695.firebaseapp.com",
            projectId: "izb-buc04-2025-22695",
            storageBucket: "izb-buc04-2025-22695.firebasestorage.app",
            messagingSenderId: "903792104813",
            appId: "1:903792104813:web:db89dd83027b792662b664",
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const storage = getStorage(app);
        const db = getFirestore(app);

        // Handle file upload for each row (person) and column (file)
        function handleFileInputChange(event, rowId, colId) {
            const file = event.target.files[0];
            if (file) {
                uploadFile(file, rowId, colId);
            }
        }

        // Function to upload file to Firebase Storage
        async function uploadFile(file, rowId, colId) {
            const storageRef = ref(storage, `uploads/person_${rowId}_file_${colId}_${file.name}`); // Unique path for each file
            const uploadTask = uploadBytesResumable(storageRef, file);

            // Monitor the upload progress
            uploadTask.on('state_changed', 
                function(snapshot) {
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    document.getElementById(`progress-${rowId}-${colId}`).style.width = progress + '%';
                }, 
                function(error) {
                    console.error('Error uploading file:', error);
                    alert('Error uploading file');
                },
                async function() {
                    // On successful upload, get the download URL
                    const downloadURL = await getDownloadURL(uploadTask.snapshot.ref());
                    const fileLink = `<a href="${downloadURL}" target="_blank">File uploaded successfully! Click here to view the file.</a>`;
                    document.getElementById(`fileUrl-${rowId}-${colId}`).innerHTML = fileLink;

                    // Save the file URL to Firestore
                    await saveFileURL(rowId, colId, downloadURL);
                }
            );
        }

        // Save file URL to Firestore
        async function saveFileURL(rowId, colId, downloadURL) {
            const fileRef = doc(db, "uploads", `person_${rowId}_file_${colId}`);
            await setDoc(fileRef, { url: downloadURL });
        }

        // Remove file from Firebase Storage and Firestore
        async function removeFile(rowId, colId) {
            const fileRef = ref(storage, `uploads/person_${rowId}_file_${colId}`);
            await deleteObject(fileRef);
            document.getElementById(`fileUrl-${rowId}-${colId}`).innerHTML = '';

            // Remove the URL from Firestore
            const fileDoc = doc(db, "uploads", `person_${rowId}_file_${colId}`);
            await deleteDoc(fileDoc);

            alert('File removed successfully');
        }

        // Load file URLs from Firestore when the page loads
        async function loadFileURLs() {
            const querySnapshot = await getDocs(collection(db, "uploads"));
            querySnapshot.forEach((doc) => {
                const { url } = doc.data();
                const [rowId, colId] = doc.id.split('_').slice(1, 3).map(Number);
                document.getElementById(`fileUrl-${rowId}-${colId}`).innerHTML = `<a href="${url}" target="_blank">File uploaded! Click here to view the file.</a>`;
            });
        }

        // Generate the table dynamically
        window.onload = function() {
            const tableBody = document.getElementById('tableBody');
            for (let i = 1; i <= 22; i++) {
                let row = document.createElement('tr');
                let personCell = document.createElement('td');
                personCell.innerText = `Person ${i}`;
                row.appendChild(personCell);

                for (let j = 1; j <= 4; j++) {
                    let cell = document.createElement('td');
                    cell.classList.add('upload-cell');

                    // Create file input
                    let fileInput = document.createElement('input');
                    fileInput.type = 'file';
                    fileInput.id = `fileInput-${i}-${j}`;
                    fileInput.addEventListener('change', function(event) {
                        handleFileInputChange(event, i, j);
                    });
                    cell.appendChild(fileInput);

                    // Create progress bar
                    let progressBar = document.createElement('div');
                    progressBar.classList.add('progress-bar');
                    let progress = document.createElement('div');
                    progress.classList.add('progress');
                    progress.id = `progress-${i}-${j}`;
                    progressBar.appendChild(progress);
                    cell.appendChild(progressBar);

                    // Create file link display
                    let fileUrl = document.createElement('div');
                    fileUrl.id = `fileUrl-${i}-${j}`;
                    cell.appendChild(fileUrl);

                    // Create remove button
                    let removeButton = document.createElement('button');
                    removeButton.innerText = 'Remove';
                    removeButton.addEventListener('click', function() {
                        removeFile(i, j);
                    });
                    cell.appendChild(removeButton);

                    row.appendChild(cell);
                }
                tableBody.appendChild(row);
            }

            // Load file URLs from Firestore
            loadFileURLs();
        };
    </script>

    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            text-align: center;
        }
        table {
            width: 100%;
            margin: 20px auto;
            border-collapse: collapse;
        }
        th, td {
            padding: 10px;
            border: 1px solid #ddd;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #f3f3f3;
            margin-top: 10px;
            border-radius: 5px;
        }
        .progress {
            height: 100%;
            background-color: #4caf50;
            width: 0%;
            border-radius: 5px;
        }
        .upload-cell {
            text-align: center;
        }
    </style>
</head>
<body>
    <h1>File Upload Table</h1>
    
    <!-- Table for 22 people and 4 upload columns -->
    <table>
        <thead>
            <tr>
                <th>Person</th>
                <th>File 1</th>
                <th>File 2</th>
                <th>File 3</th>
                <th>File 4</th>
            </tr>
        </thead>
        <tbody id="tableBody">
            <!-- Table rows will be dynamically generated by JavaScript -->
        </tbody>
    </table>
</body>
</html>
